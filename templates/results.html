{% extends "base.html" %}

{% block title %}Poll Results - Regulo PollBot{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Poll Results</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{{ url_for('export_poll_csv', poll_id=poll.id) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-filetype-csv"></i> Export CSV
                </a>
                <a href="{{ url_for('export_poll_chart', poll_id=poll.id) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-download"></i> Download Chart
                </a>
            </div>
            
            {% if poll.status == 'active' %}
                <form method="post" action="{{ url_for('close_poll_route', poll_id=poll.id) }}"
                      class="d-inline" onsubmit="return confirm('Are you sure you want to close this poll?');">
                    <button type="submit" class="btn btn-sm btn-danger">
                        <i class="bi bi-stop-circle"></i> Close Poll
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Poll Details Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold">Poll Information</h6>
                    <span class="badge {% if poll.status == 'active' %}bg-success{% elif poll.status == 'draft' %}bg-secondary{% elif poll.status == 'closed' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                        {{ poll.status|capitalize }}
                    </span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ poll.question }}</h5>
                    {% if poll.description %}
                        <p class="card-text text-muted">{{ poll.description }}</p>
                    {% endif %}
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <p><strong>Server:</strong> {{ poll.server_name }}</p>
                            <p><strong>Channel:</strong> #{{ poll.channel_name }}</p>
                            <p><strong>Created:</strong> {{ poll.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            {% if poll.message_id %}
                                <p><strong>Message ID:</strong> {{ poll.message_id }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p><strong>Multiple votes:</strong> {% if poll.allow_multiple %}Yes{% else %}No{% endif %}</p>
                            <p><strong>Anonymous:</strong> {% if poll.is_anonymous %}Yes{% else %}No{% endif %}</p>
                            <p><strong>Live results:</strong> {% if poll.show_live_results %}Yes{% else %}No{% endif %}</p>
                            {% if poll.expires_at %}
                                <p><strong>Expires:</strong> {{ poll.expires_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Visualization Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Results Visualization</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h6>Bar Chart</h6>
                            <canvas id="barChart" height="300"></canvas>
                        </div>
                        <div class="col-md-6 mb-4">
                            <h6>Pie Chart</h6>
                            <canvas id="pieChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Votes Table Card (if not anonymous) -->
            {% if not poll.is_anonymous and votes %}
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold">Votes ({{ votes|length }})</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Option</th>
                                        <th>Vote Weight</th>
                                        <th>Voted At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vote in votes %}
                                        <tr>
                                            <td>{{ vote.username }}</td>
                                            <td>{{ vote.option }}</td>
                                            <td>
                                                {% if vote.weight > 1 %}
                                                    <span class="badge bg-info">{{ vote.weight }}x</span>
                                                {% else %}
                                                    {{ vote.weight }}
                                                {% endif %}
                                            </td>
                                            <td>{{ vote.voted_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <div class="col-lg-4">
            <!-- Results Summary Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Results Summary</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-4">{{ total_votes }}</div>
                        <div class="text-muted">Total Votes</div>
                    </div>
                    
                    <hr>
                    
                    <h6 class="font-weight-bold">Options</h6>
                    <div class="list-group mt-3">
                        {% for option in options %}
                            {% set votes = results.get(option, 0) %}
                            {% set percentage = (votes / total_votes * 100) if total_votes > 0 else 0 %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span>{{ option }}</span>
                                    <span class="badge bg-primary rounded-pill">{{ votes }} vote{% if votes != 1 %}s{% endif %}</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-primary" role="progressbar" 
                                         style="width: {{ percentage }}%;" 
                                         aria-valuenow="{{ percentage }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100"></div>
                                </div>
                                <div class="small text-end mt-1">{{ percentage|round(1) }}%</div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Actions Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if poll.status == 'active' %}
                            <form method="post" action="{{ url_for('close_poll_route', poll_id=poll.id) }}"
                                  onsubmit="return confirm('Are you sure you want to close this poll?');">
                                <button type="submit" class="btn btn-danger btn-block">
                                    <i class="bi bi-stop-circle"></i> Close Poll
                                </button>
                            </form>
                        {% endif %}
                        
                        <a href="{{ url_for('edit_poll', poll_id=poll.id) }}" class="btn btn-outline-primary btn-block">
                            <i class="bi bi-pencil"></i> Edit Poll
                        </a>
                        
                        <form method="post" action="{{ url_for('delete_poll', poll_id=poll.id) }}"
                              onsubmit="return confirm('Are you sure you want to delete this poll? This action cannot be undone.');">
                            <button type="submit" class="btn btn-outline-danger btn-block">
                                <i class="bi bi-trash"></i> Delete Poll
                            </button>
                        </form>
                        
                        <a href="{{ url_for('manage_polls') }}" class="btn btn-outline-secondary btn-block">
                            <i class="bi bi-arrow-left"></i> Back to Polls
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chart configuration
        const labels = {{ chart_labels|safe }};
        const data = {{ chart_data|safe }};
        
        // Generate colors for charts
        const colors = [
            '#5865F2', '#57F287', '#FEE75C', '#EB459E', '#ED4245',
            '#9B59B6', '#3498DB', '#2ECC71', '#F1C40F', '#E74C3C'
        ];
        
        // Bar chart
        const barCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votes',
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: colors.slice(0, labels.length).map(color => color + '88'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
        
        // Pie chart
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: '#36393F',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        align: 'start'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = Math.round((value / total) * 100);
                                return `${context.label}: ${value} votes (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
